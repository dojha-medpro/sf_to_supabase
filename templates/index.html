{% extends "base.html" %}

{% block title %}Upload CSV - ETL Pipeline{% endblock %}

{% block content %}
<div class="upload-section">
    <h1>Bulk Load CSV Files</h1>
    <p class="subtitle">Upload Salesforce report CSVs and load them into Supabase staging tables</p>
    
    <!-- Webhook Dashboard -->
    <div class="dashboard-section">
        <h2>üìä Daily Webhook Activity</h2>
        
        <div class="dashboard-cards">
            <!-- Today's Summary -->
            <div class="dashboard-card">
                <h3>Today's Summary</h3>
                <div class="stats-grid">
                    <div class="stat-item success">
                        <div class="stat-value">{{ webhook_stats.today.success }}</div>
                        <div class="stat-label">Successful Webhooks</div>
                    </div>
                    <div class="stat-item {% if webhook_stats.today.failed > 0 %}danger{% else %}muted{% endif %}">
                        <div class="stat-value">{{ webhook_stats.today.failed }}</div>
                        <div class="stat-label">Failed Webhooks</div>
                    </div>
                    <div class="stat-item info">
                        <div class="stat-value">{{ webhook_stats.today.total_files }}</div>
                        <div class="stat-label">Files Processed</div>
                    </div>
                </div>
            </div>
            
            <!-- Last 7 Days Trend -->
            <div class="dashboard-card">
                <h3>Last 7 Days</h3>
                {% if webhook_stats.last_7_days %}
                <div class="trend-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Success</th>
                                <th>Failed</th>
                                <th>Files</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day in webhook_stats.last_7_days %}
                            <tr>
                                <td>{{ day.date }}</td>
                                <td class="success-text">{{ day.success }}</td>
                                <td class="{% if day.failed > 0 %}danger-text{% else %}muted-text{% endif %}">{{ day.failed }}</td>
                                <td>{{ day.total_files }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="no-data">No webhook activity in the last 7 days</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Recent Failures -->
        {% if webhook_stats.recent_failures %}
        <div class="dashboard-card alert-card">
            <h3>‚ö†Ô∏è Recent Failures</h3>
            <div class="failures-list">
                {% for failure in webhook_stats.recent_failures %}
                <div class="failure-item">
                    <div class="failure-time">{{ failure.time }}</div>
                    <div class="failure-subject">{{ failure.subject }}</div>
                    <div class="failure-from">From: {{ failure.from }}</div>
                    {% if failure.error %}
                    <div class="failure-error">{{ failure.error[:100] }}...</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <a href="{{ url_for('webhook_activity') }}" class="btn-link">View All Webhook Activity ‚Üí</a>
        </div>
        {% endif %}
    </div>
    
    <div class="upload-card">
        <form method="POST" action="/upload" enctype="multipart/form-data">
            <div class="form-group">
                <label for="csv_file">Select CSV File</label>
                <input type="file" id="csv_file" name="csv_file" accept=".csv" required>
                <small>Maximum file size: 100 MB</small>
            </div>
            
            <div class="form-group">
                <label for="mapping">Select Mapping</label>
                <select id="mapping" name="mapping" required>
                    <option value="">-- Choose a mapping --</option>
                    {% for mapping in mappings %}
                        <option value="{{ mapping }}">{{ mapping }}</option>
                    {% endfor %}
                </select>
                <small>YAML mapping file that defines the transformation rules</small>
            </div>
            
            <div class="form-group">
                <label for="partition_date">Partition Date</label>
                <input type="date" id="partition_date" name="partition_date" 
                       value="{{ today }}" required>
                <small>The load snapshot date (defaults to today)</small>
            </div>
            
            <button type="submit" class="btn-primary" id="submitBtn">
                üöÄ Upload & Process
            </button>
            
            <div id="processingIndicator" class="processing-indicator" style="display: none;">
                <div class="progress-container">
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="progress-info">
                        <span id="progressPercent">0%</span>
                        <span id="progressStage">Starting...</span>
                    </div>
                </div>
            </div>
        </form>
    </div>
    
    <div class="info-section">
        <h2>How It Works</h2>
        <ol class="steps">
            <li><strong>Upload CSV:</strong> Select your Salesforce report export</li>
            <li><strong>Choose Mapping:</strong> Pick the YAML mapping that matches your report</li>
            <li><strong>QA Validation:</strong> Automatic quality checks run before loading</li>
            <li><strong>Transform:</strong> Headers renamed, data coerced per mapping rules</li>
            <li><strong>Load:</strong> High-speed COPY into Supabase staging tables</li>
        </ol>
        
        <h3>Available Mappings</h3>
        <ul class="mapping-list">
            {% for mapping in mappings %}
                <li><code>{{ mapping }}.yaml</code></li>
            {% endfor %}
        </ul>
    </div>
</div>

<script>
document.getElementById('partition_date').valueAsDate = new Date();

let progressInterval = null;

function checkProgress(loadId) {
    fetch(`/api/progress/${loadId}`)
        .then(response => response.json())
        .then(data => {
            const progressFill = document.getElementById('progressFill');
            const progressPercent = document.getElementById('progressPercent');
            const progressStage = document.getElementById('progressStage');
            
            if (data.progress !== undefined) {
                progressFill.style.width = data.progress + '%';
                progressPercent.textContent = data.progress + '%';
            }
            
            if (data.stage) {
                progressStage.textContent = data.stage;
            }
            
            if (data.status === 'success' || data.status === 'failed') {
                clearInterval(progressInterval);
                
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error checking progress:', error);
        });
}

document.querySelector('form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const processingIndicator = document.getElementById('processingIndicator');
    const formData = new FormData(this);
    
    const fileInput = document.getElementById('csv_file');
    const mappingSelect = document.getElementById('mapping');
    
    if (!fileInput.files.length || !mappingSelect.value) {
        return;
    }
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '‚è≥ Processing...';
    processingIndicator.style.display = 'block';
    
    try {
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData
        });
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server returned non-JSON response. Please check the server logs.');
        }
        
        const data = await response.json();
        
        if (data.success && data.load_id) {
            progressInterval = setInterval(() => checkProgress(data.load_id), 500);
        } else if (data.load_id) {
            progressInterval = setInterval(() => checkProgress(data.load_id), 500);
        } else {
            alert(data.error || 'Upload failed');
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'üöÄ Upload & Process';
            processingIndicator.style.display = 'none';
        }
    } catch (error) {
        console.error('Upload error:', error);
        alert('Upload error: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'üöÄ Upload & Process';
        processingIndicator.style.display = 'none';
    }
});
</script>
{% endblock %}
